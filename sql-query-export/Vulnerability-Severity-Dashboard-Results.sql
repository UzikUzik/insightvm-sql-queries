-- Matches exploitable vulnerability by severity dashboard card pie count
-- Copy the SQL query below

with crit as (
SELECT COUNT(dv.severity) AS "Critical Vulns", 1 as line
FROM fact_asset_vulnerability_finding favf 
JOIN dim_vulnerability dv ON dv.vulnerability_id=favf.vulnerability_id
JOIN dim_asset USING(asset_id)
JOIN dim_site_asset USING(asset_id)
JOIN dim_site as ds USING(site_id)
WHERE dv.severity='Critical'
),
sev as (
SELECT COUNT(dv.severity) AS "Severe Vulns", 1 as line
FROM fact_asset_vulnerability_finding favf 
JOIN dim_vulnerability dv ON dv.vulnerability_id=favf.vulnerability_id
JOIN dim_asset USING(asset_id)
JOIN dim_site_asset USING(asset_id)
JOIN dim_site as ds USING(site_id)
WHERE dv.severity='Severe' 
),
mod as (
SELECT COUNT(dv.severity) AS "Moderate Vulns", 1 as line
FROM fact_asset_vulnerability_finding favf 
JOIN dim_vulnerability dv ON dv.vulnerability_id=favf.vulnerability_id
JOIN dim_asset USING(asset_id)
JOIN dim_site_asset USING(asset_id)
JOIN dim_site as ds USING(site_id)
WHERE dv.severity='Moderate' 
)

select "Critical Vulns", "Severe Vulns", "Moderate Vulns" from crit
join sev using(line)
join mod using(line)
