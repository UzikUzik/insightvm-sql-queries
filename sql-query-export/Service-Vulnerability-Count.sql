-- Service discovered and Vulnerabilities count against the service
--Query Will Provide:
-- Service Name
-- Port
-- AssetID
-- Protocol
-- OS Name
-- Vendor
-- Vulnerability Count against the service
-- Severity of the vulnerability against the service
WITH vuln_count AS (
	SELECT
		asset_id,
		service_id,
		COUNT(*) AS vulnerability_count,
		(
			SELECT
				severity
			FROM
				dim_vulnerability
			WHERE
				vulnerability_id = any (array_agg(DISTINCT favi.vulnerability_id))
			ORDER BY
				CASE
					WHEN severity = 'Critical' THEN 1
					WHEN severity = 'Severe' THEN 0
					WHEN severity = 'Moderate' THEN -1
				END DESC
			LIMIT
				1
		) AS severity
	FROM
		fact_asset_vulnerability_instance favi
	WHERE
		service_id <> -1
	GROUP BY
		asset_id,
		service_id
)
SELECT
	ds.name,
	das.port,
	das.asset_id,
	dp.name as protocol,
	dsf.name as os_name,
	dsf.vendor,
	COALESCE(vc.vulnerability_count, 0) AS vuln_count,
	COALESCE(severity, 'Clean') AS severity
FROM
	dim_asset_service das
	JOIN dim_service ds using (service_id)
	JOIN dim_protocol dp on dp.protocol_id = das.protocol_id
	JOIN dim_service_fingerprint dsf on dsf.service_fingerprint_id = das.service_fingerprint_id
	LEFT OUTER JOIN vuln_count vc USING (asset_id, service_id)