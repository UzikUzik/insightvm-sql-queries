-- Pulls the top 50 vulnerabilities that that have a published exploit on the most assets. and aggregates asset count and vulnerability risk score.
-- Copy the SQL query below
SELECT
    dv.title,
    dv.cvss_score,
    dv.riskscore,
    dv.exploits,
    dv.malware_kits,
    COUNT(DISTINCT da.asset_id) as asset_count,
    (COUNT(DISTINCT da.asset_id) * dv.riskscore) as asset_cnt_x_score,
    array_to_string(
        array_agg(
            (da.ip_address) || (
                CASE
                    WHEN da.host_name IS NULL THEN ''
                    ELSE ' (' || da.host_name || ')'
                END
            )
        ),
        ', '
    ) AS affected_assets
FROM
    fact_asset_vulnerability_finding
    JOIN dim_vulnerability dv USING (vulnerability_id)
    JOIN dim_asset da USING (asset_id)
WHERE
    dv.severity = 'Critical'
    AND dv.exploits != 0
GROUP BY
    dv.title,
    dv.cvss_score,
    dv.riskscore,
    dv.exploits,
    dv.malware_kits
ORDER BY
    asset_cnt_x_score desc
LIMIT
    50